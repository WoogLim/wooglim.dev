---
slug: "Docker-Mastery-13"
title:  "[Docker Mastery] - 13"
description:  "ì¿ ë²„ë„¤í‹°ìŠ¤ ì„ ì–¸ì  ì ‘ê·¼ë°©ì‹ ì´ìš©"
language:  "k8s"
category:  "devops"
update:  "2024-04-08"
hide:  false
serisenumber:  13
---

## ì‹œì‘

- [Maximilian SchwarzmÃ¼ller ë‹˜ì˜ Docker & Kubernetes : ì‹¤ì „ ê°€ì´ë“œ ê°•ì˜ë¥¼ ë“£ê³  ì‘ì„±í•œ ê¸€ì…ë‹ˆë‹¤.](https://www.udemy.com/course/docker-kubernetes-2022/?couponCode=KEEPLEARNING)

### ì„ ì–¸ì  ì ‘ê·¼ë°©ì‹

ì´ì „ ê¸€ì—ì„œëŠ” ëª…ë ¹ì  ì ‘ê·¼ ë°©ì‹ì„ ì´ìš©í•´ deploymentë¥¼ ìƒì„±í•˜ê³ , serviceë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì´ë²ˆì—” ì„ ì–¸ì  ì ‘ê·¼ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.

Dockerì˜ ê²½ìš° ëª…ë ¹ì  ì ‘ê·¼ ë°©ì‹ì€ ì´ìš©í•˜ê¸° ì–´ë ¤ì› ê³ (ëª…ë ¹ì–´ë¥¼ ëª¨ë‘ ì™¸ìš°ê³  ìˆì–´ì•¼ í•¨) docker-compose ë¡œ ëŒ€ì‹ í•´ ì„ ì–¸ì  ì ‘ê·¼ ë°©ì‹ì„ ì´ìš©í–ˆìŠµë‹ˆë‹¤.

ì§€ê¸ˆ ê¹Œì§€ ë³´ë©´ ì•„ë˜ ë‹¨ê³„ë¥¼ ê±°ì³ì™”ìŠµë‹ˆë‹¤.

ìœ„ì™€ ê°™ì´ ë¨¼ì € `kubectl create deployment ...` ë¡œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì— ëª…ë ¹ì„ ë³´ë‚´ê³  deploymentë¥¼ ë§Œë“¤ê³ , `kubectl set image deployment/first-app ...`ì™€ ê°™ì´ deployment ì´ë¯¸ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

`expose`ë¡œ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ê¸°ë„ í–ˆì£ . ëª…ë ¹ì„ ëª¨ë‘ ì™¸ìš°ê¸´ í•´ì•¼í•˜ì§€ë§Œ ì–´ë µì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ í•­ìƒ ì´ ê³¼ì •ì„ ë°˜ë³µí•´ì•¼í•˜ì£ .

ì´ ëª¨ë“  êµ¬ì„±ì„ íŒŒì¼ì— ê¸°ë¡í•  ìˆ˜ ìˆë‹¤ë©´ ë”í• ë‚˜ìœ„ ì—†ì£ . ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ì´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. YAML íŒŒì¼ì— êµ¬ì„± ì˜µì…˜ì„ ê¸°ë¡í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ì´í•´í•˜ëŠ” ê°ì²´ë¥¼ êµ¬ì„±í•˜ë©´ docker-composeì™€ ê°™ì´ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì›í•˜ëŠ” íŒŒë“œ ë° ì»¨í…Œì´ë„ˆ ìˆ˜ë¥¼ ì§€ì •í•˜ê³  ì„œë¹„ìŠ¤ì˜ êµ¬ì„± í™˜ê²½ì„ ì •ì˜í•  ìˆ˜ ìˆì£ .

docker-composeì˜ `up`ê³¼ ê°™ì´ kubectl ì—ëŠ” `apply`ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. YAML íŒŒì¼ì„ ê°€ë¦¬í‚¤ë©´ ë°°í¬ì— ëŒ€í•œ ì •ë³´ë¥¼ ì½ì–´ êµ¬ì„± íŒŒì¼ì„ í´ëŸ¬ìŠ¤í„°ì— ì ìš©í•˜ì£ .

ìš°ì„  í™˜ê²½ì„ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•©ë‹ˆë‹¤.

```bash
> kubectl get deployment
No resources found in default namespace.
> kubectl get pods
No resources found in default namespace.
> kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   5d13h
```

ì•„ë˜ì™€ ê°™ì´ YAML íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.

```yaml
# https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment ì—ì„œ ë²„ì „ í™•ì¸ ê°€ëŠ¥
apiVersion: apps/v1
# ì¿ ë²„ë„¤í‹°ìŠ¤ ê°ì²´ ì¢…ë¥˜ Deployment, Job, Demonset ...
# https://kubernetes.io/docs/reference/kubernetes-api/
kind: Deployment
# ê°ì²´ì˜ ì´ë¦„ê³¼ ê°™ì€ ì¤‘ìš” ë°ì´í„° ì •ë¦¬
# first-app ë“±ê³¼ ê°™ìŒ.
# https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#objectmeta-v1-meta
metadata:
  name: second-app-deployment
# deployment ê°ì²´ë¥¼ êµ¬ì„±í•  ì‚¬ì–‘
spec:
  # ë³µì œë³¸ íŒŒë“œ/ì»¨í…Œì´ë„ˆ ìŒ 3ê°œ (ê¸°ë³¸ 1ê°œ)
  replicas: 1
  selector:
    matchLabels:
      # deploymentì™€ ì¼ì¹˜í•˜ëŠ” í‚¤-ê°’
      # deploymentì—ê²Œ ê´€ë¦¬í•  Podë¥¼ ì§€ì •í•˜ê¸° ìœ„í•´ íŠ¹ì • íŒŒë“œì— ì§€ì •í•œ Labelsì •ë³´ë¥¼ ë§¤ì¹­í•œë‹¤.
      app: second-app
      tier: backend
  # ì´ë¯¸ì§€
  template:
    # deployment templateì˜ ê¸°ë³¸ ê°ì²´ëŠ” Podì´ë¯€ë¡œ ìƒëµ ê°€ëŠ¥
    # kind: Pod
    # ì´ë¯¸ì§€ì˜ ë©”íƒ€ë°ì´í„°
    metadata:
      # ë¼ë²¨ í‚¤ì™€ ê°’ì€ ì‚¬ìš©ì ì»¤ìŠ¤í…€
      # ì´ ê°’ìœ¼ë¡œ íŠ¹ì • ê°ì²´ë¥¼ ì§‘ì–´ë‚¼ ìˆ˜ ìˆë‹¤.
      labels:
        app: second-app
        tier: backend
    # pod ê°ì²´ë¥¼ êµ¬ì„±í•  ì‚¬ì–‘
    # https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podspec-v1-core
    spec:
      # containersëŠ” í•„ìˆ˜ë¡œ ì§€ì • í•œ íŒŒë“œë‹¹ ì»¨í…Œì´ë„ˆë¥¼ ì—¬ëŸ¬ê°œ ë„ìš¸ ìˆ˜ ìˆìŒ
      containers:
      - name: second-node-app
        image: wooglim/kub-first-app:v2
      # - name
      #   image:
```

ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ê°ì²´ ì •ë³´ê°€ ì ìš©ë©ë‹ˆë‹¤.

```bash
kubectl apply -f=deployment.yaml
deployment.apps/second-app-deployment created

> kubectl get deployments
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
second-app-deployment   1/1     1            1           47s
> kubectl get pods
NAME                                     READY   STATUS    RESTARTS   AGE
second-app-deployment-748c778fcd-92pvk   1/1     Running   0          51s
```

ì´ì–´ì„œ ì„œë¹„ìŠ¤ë„ ë…¸ì¶œì‹œì¼œë´…ì‹œë‹¤.

```bash
kubectl expose deployment first-app --port 6060:6060 --type=LoadBalancer
```

ì´ì „ì—ëŠ” ìœ„ì™€ ê°™ì€ ëª…ë ¹ì  ì ‘ê·¼ ë°©ì‹ì„ ì´ìš©í–ˆìŠµë‹ˆë‹¤.

```yaml
# https://kubernetes.io/docs/concepts/services-networking/service/
# apiVersion: core/v1 
apiVersion: v1
kind: Service
metadata:
  name: backend
spec:
  selector:
    # second-app ë ˆì´ë¸”ì„ ê°€ì§„ ëª¨ë“  PodëŠ” ì´ Serviceì— ì˜í•´ ì œì–´
    app: second-app
  ports:
  # í”„ë¡œí† ì½œ
  - protocol: 'TCP'
    # ì™¸ë¶€ ë…¸ì¶œ í¬íŠ¸
    port: 80
    # ë‚´ë¶€ í¬íŠ¸
    targetPort: 8080
  # - protocol: 'TCP'
  #   port: 443
  #   targetPort: 443
  # ClusterIP: í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì´ìš©
  # NodePort: ì‹¤í–‰ë˜ëŠ” ì›Œì»¤ ë…¸ë“œì˜ IPì™€ í¬íŠ¸ ì™¸ë¶€ ë…¸ì¶œ
  # LoadBalancer: ê°€ì¥ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì™¸ë¶€ ë…¸ì¶œ íƒ€ì… íŠ¸ë˜í”½ ë¶„ì‚° ì§€ì›
  type: LoadBalance
```

ì´ì œ ì•„ë˜ì™€ ê°™ì´ ëª…ë ¹ì„ ì‹¤í–‰í•´ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

```bash
> kubectl apply -f service.yaml
service/backend created
> kubectl get services
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
backend      LoadBalancer   10.100.151.117   <pending>     80:30827/TCP   6s
kubernetes   ClusterIP      10.96.0.1        <none>        443/TCP        5d14h
> minikube service backend
|-----------|---------|-------------|---------------------------|
| NAMESPACE |  NAME   | TARGET PORT |            URL            |
|-----------|---------|-------------|---------------------------|
| default   | backend |          80 | http://xxx.xxx.xx.x:30827 |
|-----------|---------|-------------|---------------------------|
ğŸƒ  backend ì„œë¹„ìŠ¤ì˜ í„°ë„ì„ ì‹œì‘í•˜ëŠ” ì¤‘
|-----------|---------|-------------|------------------------|
| NAMESPACE |  NAME   | TARGET PORT |          URL           |
|-----------|---------|-------------|------------------------|
| default   | backend |             | http://127.0.0.1:51801 |
|-----------|---------|-------------|------------------------|
ğŸ‰  Opening service default/backend in default browser...
â—  darwin ì—ì„œ Docker ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì—, í„°ë¯¸ë„ì„ ì—´ì–´ì•¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
```

ì´ê²ƒì´ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì„ ì–¸ì  ë°©ë²•ì˜ ì˜ˆì‹œì…ë‹ˆë‹¤. ìœ ì§€ë³´ìˆ˜ê°€ í›¨ì”¬ ì‰¬ì›Œì§€ì£ .

ë³€ê²½ ì‚¬í•­ì´ ì¼ì–´ë‚˜ë©´ ê·¸ì € `apply`ë§Œ ë‹¤ì‹œ ìˆ˜í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

```yaml
replicas: 3
```

ë³µì œë³¸ì„ 3ê°œë¡œ ëŠ˜ë ¤ë´…ì‹œë‹¤.

```bash
> kubectl apply -f=deployment.yaml
deployment.apps/second-app-deployment configured

> kubectl get pods
NAME                                     READY   STATUS    RESTARTS   AGE
second-app-deployment-748c778fcd-92pvk   1/1     Running   0          18m
second-app-deployment-748c778fcd-9blls   1/1     Running   0          39s
second-app-deployment-748c778fcd-wsst6   1/1     Running   0          39s
```

ë¦¬ì†ŒìŠ¤ë¥¼ ì œê±°í•  ë•ŒëŠ” ì•„ë˜ì™€ ê°™ì´ ìƒì„±í–ˆë˜ íŒŒì¼ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤.

```bash
> kubectl delete -f=deployment.yaml -f=service.yaml
deployment.apps "second-app-deployment" deleted
service "backend" deleted
```

YAML íŒŒì¼ì„ í•˜ë‚˜ë¡œ í•©ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¢…ë¥˜ ë³„ë¡œ `---`ë¡œ êµ¬ë¶„ë§Œ í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: backend
spec:
  selector:
    app: second-app
  ports:
  - protocol: 'TCP'
    port: 80
    targetPort: 8080
  type: LoadBalancer
---
apiVersion: apps/v1
metadata:
  name: second-app-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: second-app
      tier: backend
  template:
    metadata:
      labels:
        app: second-app
        tier: backend
    spec:
      containers:
      - name: second-node-app
        image: wooglim/kub-first-app:v2
```

Serviceë¥¼ ìš°ì„  ìƒì„±í•˜ê³  ì¶”ê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ëŠ”ê²Œ ì¢‹ìŠµë‹ˆë‹¤. Serviceì— ì •ì˜ëœ selecorì •ë³´ëŠ” ìì›ì„ í•­ìƒ ëª¨ë‹ˆí„°ë§í•˜ê¸° ë•Œë¬¸ì— ì´í›„ ìƒì„±ë˜ëŠ” ëª¨ë“  ë¶€ë¶„ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.

```bash
> kubectl apply -f=master-deployment.yaml
service/backend created
deployment.apps/second-app-deployment created
> minikube service backend
|-----------|---------|-------------|---------------------------|
| NAMESPACE |  NAME   | TARGET PORT |            URL            |
|-----------|---------|-------------|---------------------------|
| default   | backend |          80 | http://xxx.xxx.xx.x:30175 |
|-----------|---------|-------------|---------------------------|
ğŸƒ  backend ì„œë¹„ìŠ¤ì˜ í„°ë„ì„ ì‹œì‘í•˜ëŠ” ì¤‘
|-----------|---------|-------------|------------------------|
| NAMESPACE |  NAME   | TARGET PORT |          URL           |
|-----------|---------|-------------|------------------------|
| default   | backend |             | http://127.0.0.1:52109 |
|-----------|---------|-------------|------------------------|
ğŸ‰  Opening service default/backend in default browser...
â—  darwin ì—ì„œ Docker ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì—, í„°ë¯¸ë„ì„ ì—´ì–´ì•¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
```

### Labelsì™€ Selector

íŒŒë“œì—ì„œ í…œí”Œë¦¿ Labelsë¡œ ì •ì˜í•œ í‚¤-ê°’ìœ¼ë¡œ Deploymendì—ì„œ selectorë¡œ ê´€ë¦¬í•  Podë¥¼ ì§€ì •í–ˆì—ˆìŠµë‹ˆë‹¤. `matchLabels`ë¥¼ ì´ìš©í–ˆì—ˆì£ .

`macthExpressions`ë¥¼ ì´ìš©í•˜ë©´ ì¢€ ë” ì„¸ë¶€ì ì¸ ì¡°ê±´ì‹ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œëŠ” `matchLabels`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: second-app-deployment
spec:
  replicas: 1
  selector:
    # matchLabels:
    #   app: second-app
    #   tier: backend
    # https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/
    matchExpressions:
      # app ë ˆì´ë¸”í‚¤ì˜ ê°’ì´ second-app, first-appì— ì†í•˜ëŠ” Pod ê´€ë¦¬
      - {key: app, operator: In, value: [second-app, first-app]}
  template:
    metadata:
      labels:
        app: second-app
        tier: backend
    spec:
      containers:
      - name: second-node-app
        image: wooglim/kub-first-app:v2
```

ì•„ë˜ì™€ ê°™ì´ labelsë¥¼ ì´ìš©í•´ ì œê±°í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```bash
> kubectl get service
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
backend      LoadBalancer   10.100.165.103   <pending>     80:31822/TCP   38s
kubernetes   ClusterIP      10.96.0.1        <none>        443/TCP        5d14h

> kubectl get deployments
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
second-app-deployment   1/1     1            1           42s

kubectl delete deployments,services -l group=example

> kubectl delete deployments,services -l group=example
service "backend" deleted
> kubectl get service
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   5d14h
> kubectl get deployments
No resources found in default namespace.
```

ì¶”ê°€ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ Podì™€ ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ `livenessProbe`ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yaml
spec:
      # containersëŠ” í•„ìˆ˜ë¡œ ì§€ì • í•œ íŒŒë“œë‹¹ ì»¨í…Œì´ë„ˆë¥¼ ì—¬ëŸ¬ê°œ ë„ìš¸ ìˆ˜ ìˆìŒ
      containers:
      - name: second-node-app
        image: wooglim/kub-first-app:v2
        # https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          periodSeconds: 10
          initialDelaySeconds: 5
```

10ì´ˆ ë™ì•ˆ GET ìš”ì²­ì´ ì„±ê³µí•˜ëŠ”ì§€ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ê²Œ 5ì´ˆ ì£¼ê¸°ë¡œ ì•Œë¦½ë‹ˆë‹¤. ì´ìƒì´ ìƒê¸´ ê²½ìš° ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘í•˜ê²Œ ë©ë‹ˆë‹¤. 

Docker-composeì˜ ê²½ìš° ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•˜ëŠ” ë°©ë²•ì„ ì •ì˜í–ˆì§€ë§Œ ì§€ê¸ˆì€ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•˜ëŠ” ë°©ë²•ì„ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë” í° ë²”ìœ„ì´ì£ . ë§Œì¼ ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€ë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ê°±ì‹ í•˜ì—¬ ê°€ì ¸ì˜¤ê³  ì‹¶ì€ ê²½ìš° `latest`ë¥¼ ì´ìš©í•  ìˆ˜ ìˆê² ì£  ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yaml
spec:
      # containersëŠ” í•„ìˆ˜ë¡œ ì§€ì • í•œ íŒŒë“œë‹¹ ì»¨í…Œì´ë„ˆë¥¼ ì—¬ëŸ¬ê°œ ë„ìš¸ ìˆ˜ ìˆìŒ
      containers:
      - name: second-node-app
        image: wooglim/kub-first-app:latest
        # https://kubernetes.io/docs/concepts/containers/images/
        imagePullPolicy: Always
```

ì´ì „ì— êµ¬ë²„ì „ì˜ ì´ë¯¸ì§€ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰ì¤‘ì¸ ê²½ìš° í•´ë‹¹ íŒŒë“œëŠ” ì¢…ë£Œë˜ê³  ìƒˆë¡œìš´ íŒŒë“œë¡œ êµì²´ê°€ ë©ë‹ˆë‹¤.

ë” ìì„¸í•œ ì‚¬ìš©ì„ ìœ„í•´ì„œëŠ” ê³µì‹ ë¬¸ì„œë¥¼ ì½ì–´ì•¼ í•©ë‹ˆë‹¤.