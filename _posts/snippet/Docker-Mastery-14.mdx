---
title:  "[Docker Mastery] - 14"
description:  "ì¿ ë²„ë„¤í‹°ìŠ¤ Volume"
language:  "devops"
category:  "Docker"
update:  "2024-04-12"
hide:  false
serisenumber:  14
---

## ì‹œì‘

- [Maximilian SchwarzmÃ¼ller ë‹˜ì˜ Docker & Kubernetes : ì‹¤ì „ ê°€ì´ë“œ ê°•ì˜ë¥¼ ë“£ê³  ì‘ì„±í•œ ê¸€ì…ë‹ˆë‹¤.](https://www.udemy.com/course/docker-kubernetes-2022/?couponCode=KEEPLEARNING)

### ë³¼ë¥¨

minikubeëŠ” í˜¸ìŠ¤íŠ¸ë‚´ ê°€ìƒë¨¸ì‹ ì…ë‹ˆë‹¤. ì»¨í…Œì´ë„ˆë¥¼ ë°°í¬í• ë•Œ í´ëŸ¬ìŠ¤í„° í˜¹ì€ í˜¸ìŠ¤íŠ¸ì—ì„œ ë„ì»¤ë¡œ ì‘ì—…í•  ë•Œ, ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ê±°ë‚˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œ í˜¸ìŠ¤íŒ…í•˜ëŠ” Podê°€ ì œê±°ë˜ë©´ ë°ì´í„°ê°€ ìœ ì‹¤ëì£ . ì´ì œ ë°ì´í„°ë¥¼ ìœ ì‹¤í•˜ì§€ ì•Šê³  ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

ë³¼ë¥¨ì˜ ì¢…ë¥˜ë¡œëŠ” ì¼ë°˜ ë³¼ë¥¨, ì˜êµ¬ ë³¼ë¥¨, ì˜êµ¬ ë³¼ë¥¨ í´ë ˆì„ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìˆœì°¨ì ìœ¼ë¡œ ì•Œì•„ë´…ì‹œë‹¤.

#### State ì´í•´í•˜ê¸°

ì‚¬ìš©ì ìƒì„± ë°ì´í„°, ì‚¬ìš©ì ê³„ì •, ì•±ì— ê´€í•œ ë°ì´í„° ë“± ì¼ë°˜ì ìœ¼ë¡œ DBì— ì €ì¥í•˜ì§€ë§Œ ì˜ˆë¡œ íŒŒì¼ë¡œë„ ì €ì¥í•  ìˆ˜ ìˆì£ . ì„ì‹œ DBí…Œì´ë¸”ì¸ ë©”ëª¨ë¦¬ì— ì €ì¥í•  ìˆ˜ë„ ìˆêµ¬ìš”. ì»¨í…Œì´ë„ˆê°€ ì¤‘ì§€ë˜ë”ë¼ë„ ì´ëŸ¬í•œ ë°ì´í„°ë“¤ì€ ìœ ì‹¤ë˜ë©´ ì•ˆë˜ê² ì£ .

ì´ì œ íŒŒë“œë‚´ ì»¨í…Œì´ë„ˆì— ë³¼ë¥¨ì„ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.

ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë§ˆìš´íŠ¸ ë³¼ë¥¨ì„ ì„¤ì •í•˜ëŠ” ê²ƒì„ ì§€ì›í•©ë‹ˆë‹¤. ë¡œì»¬ ë³¼ë¥¨(ì›Œì»¤ë…¸ë“œ) ë§ê³ ë„ ë˜í•œ ë‹¤ë¥¸ í´ë¼ìš°ë“œ ë° í˜¸ìŠ¤íŒ… í”„ë¡œë°”ì´ë”ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë³¼ë¥¨ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë³¼ë¥¨ì€ íŒŒë“œë§ˆë‹¤ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒëª…ì£¼ê¸°ë„ íŒŒë“œë¥¼ ë”°ë¼ê°‘ë‹ˆë‹¤. ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ë©´ ë³¼ë¥¨ì€ ì‚´ì•„ìˆì§€ë§Œ Podê°€ íŒŒê´´ë˜ë©´ ë³¼ë¥¨ ë˜í•œ íŒŒê´´ë©ë‹ˆë‹¤. Podë˜í•œ ì¼ì¢…ì˜ ì»´í“¨í„°ë¼ê³  ë³´ë©´ ë˜ê² êµ°ìš”. Podë¥¼ ì œê±°í•œ í›„ì—ë„ ë³¼ë¥¨ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ì— ëŒ€í•´ì„œëŠ” ì°¨í›„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

ì¿ ë²„ë„¤í‹°ìŠ¤ ë³¼ë¥¨ì€ ë„ì»¤ë³´ë‹¤ ì¡°ê¸ˆ ë” ê°•ë ¥í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ë“œë¼ì´ë²„ì™€ ìœ í˜•ì„ ì§€ì›í•˜ë©° ë°ì´í„°ê°€ ì €ì¥ë˜ëŠ” ìœ„ì¹˜ë¥¼ ì™„ë²½íˆ ì œì–´í•  ìˆ˜ ìˆì£ .

ë³¼ë¥¨ì€ ë°˜ë“œì‹œ ì˜êµ¬ì ì¸ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì»¨í…Œì´ë„ˆëŠ” Podì˜ ì¬ì‹œì‘ì—ë„ ì‚´ì•„ìˆì§€ë§Œ ë³¼ë¥¨ì€ ì œê±°ë©ë‹ˆë‹¤. ë°˜ë©´ ë„ì»¤ëŠ” ì œê±°í•˜ì§€ ì•ŠëŠ” í•œ ë³¼ë¥¨ì´ ì‚´ì•„ìˆì£ .

### ì‹œì‘í•˜ê¸°

ìš°ì„  ë‹¤ìŒê³¼ ê°™ì€ Node ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. APIëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
```js

const filePath = path.join(__dirname, 'story', 'text.txt');

app.get('/story', (req, res) => {
  fs.readFile(filePath, (err, data) => {
    if (err) {
      return res.status(500).json({ message: 'Failed to open file.' });
    }
    res.status(200).json({ story: data.toString() });
  });
});

app.post('/story', (req, res) => {
  const newText = req.body.text;
  if (newText.trim().length === 0) {
    return res.status(422).json({ message: 'Text must not be empty!' });
  }
  fs.appendFile(filePath, newText + '\n', (err) => {
    if (err) {
      return res.status(500).json({ message: 'Storing the text failed.' });
    }
    res.status(201).json({ message: 'Text was stored!' });
  });
});
```

ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ìœ„í•´ Dockerfileì„ ì‘ì„±í•©ë‹ˆë‹¤.

```yaml
FROM node:14-alpine

WORKDIR /app

COPY package.json .

RUN npm install

COPY . .

EXPOSE 3000

CMD [ "node", "app.js" ]
```

deployments yaml ì…ë‹ˆë‹¤.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: story-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: story
  template:
    # kind: Pod
    metadata:
      labels:
        app: story
    spec:
      containers:
      - name: story
        image: ìƒì„±í•œ ì´ë¯¸ì§€
```

ì´ì–´ì„œ service yaml ì…ë‹ˆë‹¤.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: story-service
spec:
  selector:
    # matchLabels: ìƒëµ
    app: story
  type: LoadBalancer
  ports:
  - protocol: "TCP"
    # ì™¸ë¶€ ë…¸ì¶œ í¬íŠ¸
    port: 80
    targetPort: 3000
```

ì„œë¹„ìŠ¤ ë° ë°°í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
kubectl apply -f=service.yaml -f=deployment.yaml

> kubectl get deployments
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
story-deployment   1/1     1            1           3d2h
> kubectl get service
NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes      ClusterIP      10.96.0.1       <none>        443/TCP        9d
story-service   LoadBalancer   10.107.85.248   <pending>     80:31774/TCP   3d2h
> minikube service story-service
|-----------|---------------|-------------|---------------------------|
| NAMESPACE |     NAME      | TARGET PORT |            URL            |
|-----------|---------------|-------------|---------------------------|
| default   | story-service |          80 | http://192.168.49.2:31774 |
|-----------|---------------|-------------|---------------------------|
ğŸƒ  story-service ì„œë¹„ìŠ¤ì˜ í„°ë„ì„ ì‹œì‘í•˜ëŠ” ì¤‘
|-----------|---------------|-------------|------------------------|
| NAMESPACE |     NAME      | TARGET PORT |          URL           |
|-----------|---------------|-------------|------------------------|
| default   | story-service |             | http://127.0.0.1:50204 |
|-----------|---------------|-------------|------------------------|
ğŸ‰  Opening service default/story-service in default browser...
â—  darwin ì—ì„œ Docker ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì—, í„°ë¯¸ë„ì„ ì—´ì–´ì•¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
```

í•´ë‹¹ ì„œë¹„ìŠ¤ì—ì„œëŠ” GET ìš”ì²­ìœ¼ë¡œ í…ìŠ¤íŠ¸ì˜ ì €ì¥ í…ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  POSTìš”ì²­ìœ¼ë¡œëŠ” í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ì´ ìƒí™©ì—ì„œ íŒŒë“œê°€ ì¬ì‹œì‘ëœë‹¤ë©´ ë°ì´í„°ëŠ” ì‚¬ë¼ì§ˆê²ë‹ˆë‹¤.

ë°ì´í„°ë¥¼ ì œê±°í•˜ì§€ ì•Šë„ë¡ [ë³¼ë¥¨](https://kubernetes.io/docs/concepts/storage/volumes/) ì„¤ì •ì„ ì‹œì‘í•´ë´…ì‹œë‹¤. 

ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë‹¤ì–‘í•œ ë³¼ë¥¨ íƒ€ì…ê³¼ ë“œë¼ì´ë²„ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì§€ê¸ˆì€ minikube ë¥¼ ì´ìš©í•´ ë¡œì»¬ì—ì„œ ê°€ìƒë¨¸ì‹ ìœ¼ë¡œ ë…¸ë“œë¥¼ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.

íŠ¹ì • í´ë¼ìš°ë“œ í”„ë¡œë°”ì´ë” ë˜ëŠ” ë°ì´í„° ì„¼í„°ì— ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•˜ë ¤ë©´ ê³µì‹ DOCSë¥¼ ì°¸ê³ í•˜ë©´ ë©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ë³¼ë¥¨ ë° íƒ€ì…ë³„ YAML ì‘ì„±ë²•ì´ ë‚˜ì™€ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.

ìš°ì„  CSI ìœ í˜•ì— ì¤‘ì ì„ ë‘ê³  ì§„í–‰í•©ë‹ˆë‹¤. `emptyDir` > `hostPath` ìˆœìœ¼ë¡œ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.

### emptyDir ìœ í˜•ìœ¼ë¡œ ë³¼ë¥¨ êµ¬ì„±í•˜ê¸°

ë³¼ë¥¨ì˜ ìˆ˜ëª…ì€ íŒŒë“œì™€ ì§ê²°ë©ë‹ˆë‹¤. íŒŒë“œë³„ë¡œ ë‹¤ë¥´êµ¬ìš”. ë•Œë¬¸ì— Podë¥¼ ì •ì˜í•˜ëŠ” ìœ„ì¹˜ì— ë³¼ë¥¨ì„ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ì „ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê¸°ì „ ì½”ë“œë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.

```js
app.get('/error', () => {
  process.exit(1)
})
```

error APIë¥¼ í˜¸ì¶œí•˜ë©´ ì„œë²„ê°€ ì¢…ë£Œë˜ë„ë¡ í•´ë´…ì‹œë‹¤. ì´ìƒ ì§•í›„ê°€ ë°œê²¬ë˜ë©´ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì—ì„œ íŒŒë“œë¥¼ ì¬ì‹¤í–‰í• ê²ë‹ˆë‹¤.

deployment yamlì—ì„œ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•œ ë’¤ ì„¤ì • íŒŒì¼ì„ ì ìš©í•©ë‹ˆë‹¤.

```bash
kubectl apply -f=deployment.yaml

# íŒŒë“œê°€ ì •ìƒ ì‹¤í–‰ë˜ë©´ ì´ì „ íŒŒë“œëŠ” ì œê±°ë¨.
kubectl get pods
NAME                                READY   STATUS        RESTARTS      AGE
story-deployment-7db5f4c576-f9z8c   1/1     Running       0             32s
story-deployment-cbf5f7f47-fg72b    1/1     Terminating   1 (40m ago)   3d3h

minikube service story-service
```

ì´ì œ ì•„ë˜ì™€ ê°™ì´ íŒŒë“œê°€ ì‹¤í–‰ëì„ë•Œ, ìš”ì²­ì„ ë³´ë‚´ë´…ì‹œë‹¤.

```bash
> kubectl get pods
NAME                                READY   STATUS    RESTARTS     AGE
story-deployment-7db5f4c576-f9z8c   1/1     Running   1 (7s ago)   2m18s
```

íŒŒë“œê°€ ì •ìƒ ì‹¤í–‰ì¤‘ì…ë‹ˆë‹¤. Postmanì„ ì´ìš©í•´ Post ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.

![volume-test-post](/snippets/kube/chap2/postman-post.png)

í…ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•œ ê²°ê³¼ì…ë‹ˆë‹¤.

![volume-test-get](/snippets/kube/chap2/postman-get.png)

ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ë„ë¡ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.

![volume-error-get](/snippets/kube/chap2/postman-error-get.png)

ì»¨í…Œì´ë„ˆì— ì´ìƒì´ ê°ì§€ë˜ì–´ íŒŒë“œë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤.

```bash
> kubectl get pods
NAME                                READY   STATUS   RESTARTS       AGE
story-deployment-7db5f4c576-f9z8c   0/1     Error    1 (108s ago)   3m59s
> kubectl get pods
NAME                                READY   STATUS             RESTARTS      AGE
story-deployment-7db5f4c576-f9z8c   0/1     CrashLoopBackOff   1 (14s ago)   4m6s
> kubectl get pods
NAME                                READY   STATUS    RESTARTS      AGE
story-deployment-7db5f4c576-f9z8c   1/1     Running   2 (16s ago)   4m8s
```

ë‹¤ì‹œ GET ìš”ì²­ì„ ë³´ë‚´ì§€ë§Œ ì´ì „ ë°ì´í„°ëŠ” ì œê±°ë©ë‹ˆë‹¤.

![retry-volume-test-get](/snippets/kube/chap2/postman-retry-get.png)

ì´ì œ ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì–´ë„ ë°ì´í„°ê°€ ë³´ì¡´ë˜ë„ë¡ ì„¤ì •ì„ ë³€ê²½í•´ë³´ê² ìŠµë‹ˆë‹¤.

